generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // Used for migrations in serverless
}

model User {
  id             String    @id @default(uuid())
  email          String    @unique
  passwordHash   String
  name           String
  avatarUrl      String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  
  profile        UserProfile?
  workouts       Workout[]
  exercises      Exercise[]
  templates      WorkoutTemplate[]
  personalRecords PersonalRecord[]
  nutritionLogs  NutritionLog[]
  
  // Gamification
  stats          UserStats?
  achievements   UserAchievement[]
  
  // Social
  followers      Follow[] @relation("Following")
  following      Follow[] @relation("Followers")
  workoutLikes   WorkoutLike[]
  workoutComments WorkoutComment[]
  
  // Recovery
  muscleRecovery MuscleRecovery[]
  
  // Guilds
  guildMembership GuildMember?
  
  // Workout Parties
  hostedParties   WorkoutParty[] @relation("PartyHost")
  partyParticipations PartyParticipant[]
  partyEvents     PartyEvent[]
  
  // Leaderboards & Predictions
  exerciseLeaderboards ExerciseLeaderboard[]
  prPredictions   PRPrediction[]
  
  @@map("users")
}

model UserProfile {
  id                String   @id @default(uuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  fitnessGoal       String   @default("general") // strength, hypertrophy, endurance, fat_loss, general
  experienceLevel   String   @default("beginner") // beginner, intermediate, advanced
  weight            Float?   // in kg
  height            Float?   // in cm
  birthDate         DateTime?
  gender            String?
  preferredUnits    String   @default("metric") // metric, imperial
  weeklyGoal        Int      @default(3) // workouts per week
  restDayReminder   Boolean  @default(true)
  workoutReminder   Boolean  @default(true)
  reminderTime      String?  // HH:MM format
  timezone          String   @default("UTC")
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@map("user_profiles")
}

model Exercise {
  id              String   @id @default(uuid())
  name            String
  description     String?
  muscleGroup     String   // chest, back, shoulders, biceps, triceps, legs, core, cardio, full_body
  category        String   // compound, isolation, bodyweight, cardio, stretching
  equipment       String?  // barbell, dumbbell, cable, machine, bodyweight, kettlebell, bands
  instructions    String?
  isCustom        Boolean  @default(false)
  isPublic        Boolean  @default(false)
  
  userId          String?  // null for system exercises
  user            User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  workoutExercises WorkoutExercise[]
  templateExercises TemplateExercise[]
  personalRecords PersonalRecord[]
  leaderboardEntries ExerciseLeaderboard[]
  prPredictions   PRPrediction[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([name, userId])
  @@map("exercises")
}

model Workout {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name            String
  date            DateTime
  startTime       DateTime?
  endTime         DateTime?
  duration        Int?     // in minutes
  notes           String?
  status          String   @default("planned") // planned, in_progress, completed, cancelled
  rating          Int?     // 1-5 user satisfaction rating
  perceivedEffort Int?     // 1-10 RPE scale
  visibility      String   @default("private") // private, followers, public
  
  templateId      String?
  template        WorkoutTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  
  exercises       WorkoutExercise[]
  likes           WorkoutLike[]
  comments        WorkoutComment[]
  partyParticipants PartyParticipant[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([userId, date])
  @@map("workouts")
}

model WorkoutExercise {
  id              String   @id @default(uuid())
  workoutId       String
  workout         Workout  @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  exerciseId      String
  exercise        Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  
  order           Int
  notes           String?
  
  sets            ExerciseSet[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([workoutId])
  @@map("workout_exercises")
}

model ExerciseSet {
  id                  String   @id @default(uuid())
  workoutExerciseId   String
  workoutExercise     WorkoutExercise @relation(fields: [workoutExerciseId], references: [id], onDelete: Cascade)
  
  setNumber           Int
  setType             String   @default("working") // warmup, working, dropset, failure, rest_pause
  targetReps          Int?
  actualReps          Int?
  weight              Float?   // in kg or lbs based on user preference
  duration            Int?     // in seconds for timed exercises
  distance            Float?   // for cardio
  restTime            Int?     // in seconds
  rpe                 Int?     // 1-10 rating of perceived exertion
  isCompleted         Boolean  @default(false)
  isPR                Boolean  @default(false)
  notes               String?
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@index([workoutExerciseId])
  @@map("exercise_sets")
}

model WorkoutTemplate {
  id              String   @id @default(uuid())
  userId          String?  // null for system templates
  user            User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name            String
  description     String?
  category        String   @default("custom") // push_pull_legs, upper_lower, full_body, bro_split, custom
  targetMuscles   String?  // comma-separated muscle groups
  estimatedDuration Int?   // in minutes
  difficulty      String   @default("intermediate") // beginner, intermediate, advanced
  isPublic        Boolean  @default(false)
  
  exercises       TemplateExercise[]
  workouts        Workout[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("workout_templates")
}

model TemplateExercise {
  id              String   @id @default(uuid())
  templateId      String
  template        WorkoutTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  exerciseId      String
  exercise        Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  
  order           Int
  sets            Int      @default(3)
  targetReps      String?  // can be range like "8-12"
  targetWeight    Float?
  restTime        Int?     // in seconds
  notes           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([templateId])
  @@map("template_exercises")
}

model PersonalRecord {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  exerciseId      String
  exercise        Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  
  recordType      String   // max_weight, max_reps, max_volume, best_time
  value           Float
  reps            Int?
  weight          Float?
  date            DateTime
  notes           String?
  
  createdAt       DateTime @default(now())
  
  @@index([userId, exerciseId])
  @@map("personal_records")
}

model NutritionLog {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  date            DateTime
  mealType        String?  // breakfast, lunch, dinner, snack
  calories        Int?
  protein         Float?   // in grams
  carbs           Float?   // in grams
  fat             Float?   // in grams
  fiber           Float?   // in grams
  notes           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([userId, date])
  @@map("nutrition_logs")
}

// ==================== GAMIFICATION ====================

model Achievement {
  id              String   @id @default(uuid())
  name            String   @unique
  description     String
  category        String   // workout, strength, consistency, volume, special
  icon            String   // lucide icon name
  rarity          String   @default("common") // common, uncommon, rare, epic, legendary
  requirement     Json     // { type: "workout_count", value: 10 }
  xpReward        Int      @default(50)
  isSecret        Boolean  @default(false)
  
  userAchievements UserAchievement[]
  
  createdAt       DateTime @default(now())
  
  @@map("achievements")
}

model UserAchievement {
  id            String      @id @default(uuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievementId String
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  unlockedAt    DateTime    @default(now())
  progress      Float       @default(0) // 0-100 for progressive achievements
  
  @@unique([userId, achievementId])
  @@index([userId])
  @@map("user_achievements")
}

model UserStats {
  id              String    @id @default(uuid())
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // XP & Level
  totalXP         Int       @default(0)
  currentLevel    Int       @default(1)
  
  // Workout Stats
  totalWorkouts   Int       @default(0)
  totalExercises  Int       @default(0)
  totalSets       Int       @default(0)
  totalReps       Int       @default(0)
  totalWeight     Float     @default(0) // kg
  totalDuration   Int       @default(0) // minutes
  
  // Streaks
  currentStreak   Int       @default(0)
  longestStreak   Int       @default(0)
  lastWorkoutDate DateTime?
  
  // Records
  totalPRs        Int       @default(0)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@map("user_stats")
}

// ==================== SOCIAL ====================

model Follow {
  id          String   @id @default(uuid())
  followerId  String
  follower    User     @relation("Followers", fields: [followerId], references: [id], onDelete: Cascade)
  followingId String
  following   User     @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  
  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@map("follows")
}

model WorkoutLike {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  workoutId String
  workout   Workout  @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  
  @@unique([userId, workoutId])
  @@index([workoutId])
  @@map("workout_likes")
}

model WorkoutComment {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  workoutId String
  workout   Workout  @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([workoutId])
  @@map("workout_comments")
}

// ==================== MUSCLE RECOVERY ====================

model MuscleRecovery {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  muscleGroup   String   // chest, back, shoulders, biceps, triceps, legs, core
  lastTrained   DateTime
  totalSets     Int      @default(0)
  totalVolume   Float    @default(0) // weight * reps
  recoveryHours Int      @default(48) // estimated hours to recover
  
  updatedAt     DateTime @updatedAt
  
  @@unique([userId, muscleGroup])
  @@map("muscle_recovery")
}

// ==================== GUILDS (Team Competition) ====================

model Guild {
  id              String   @id @default(uuid())
  name            String   @unique
  description     String?
  avatarUrl       String?
  guildType       String   @default("public") // public, private, corporate
  maxMembers      Int      @default(50)
  totalXP         Int      @default(0)
  seasonXP        Int      @default(0)
  tier            String   @default("bronze") // bronze, silver, gold, platinum, diamond
  totalWorkouts   Int      @default(0)
  totalVolume     Float    @default(0)
  leaderId        String
  
  members         GuildMember[]
  challengesSent  GuildChallenge[] @relation("ChallengerGuild")
  challengesReceived GuildChallenge[] @relation("DefenderGuild")
  wonChallenges   GuildChallenge[] @relation("WinnerGuild")
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("guilds")
}

model GuildMember {
  id              String   @id @default(uuid())
  guildId         String
  guild           Guild    @relation(fields: [guildId], references: [id], onDelete: Cascade)
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role            String   @default("member") // leader, officer, member
  xpContributed   Int      @default(0)
  workoutsContributed Int  @default(0)
  joinedAt        DateTime @default(now())
  
  @@unique([guildId, userId])
  @@unique([userId]) // User can only be in one guild
  @@index([guildId])
  @@map("guild_members")
}

model GuildChallenge {
  id              String   @id @default(uuid())
  challengerGuildId String
  challengerGuild Guild    @relation("ChallengerGuild", fields: [challengerGuildId], references: [id], onDelete: Cascade)
  defenderGuildId String
  defenderGuild   Guild    @relation("DefenderGuild", fields: [defenderGuildId], references: [id], onDelete: Cascade)
  
  challengeType   String   // total_volume, workout_count, total_xp
  targetValue     Int?
  xpStake         Int      @default(500)
  
  challengerScore Float    @default(0)
  defenderScore   Float    @default(0)
  
  status          String   @default("pending") // pending, active, completed, declined
  winnerGuildId   String?
  winnerGuild     Guild?   @relation("WinnerGuild", fields: [winnerGuildId], references: [id])
  
  startsAt        DateTime
  endsAt          DateTime
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("guild_challenges")
}

// ==================== WORKOUT PARTIES (Real-time Social) ====================

model WorkoutParty {
  id              String   @id @default(uuid())
  hostId          String
  host            User     @relation("PartyHost", fields: [hostId], references: [id], onDelete: Cascade)
  code            String   @unique // 6-char alphanumeric
  name            String?
  status          String   @default("waiting") // waiting, active, completed
  maxParticipants Int      @default(10)
  
  startedAt       DateTime?
  endedAt         DateTime?
  expiresAt       DateTime
  
  participants    PartyParticipant[]
  events          PartyEvent[]
  
  createdAt       DateTime @default(now())
  
  @@index([code])
  @@index([status])
  @@map("workout_parties")
}

model PartyParticipant {
  id              String   @id @default(uuid())
  partyId         String
  party           WorkoutParty @relation(fields: [partyId], references: [id], onDelete: Cascade)
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  workoutId       String?
  workout         Workout? @relation(fields: [workoutId], references: [id])
  
  totalSets       Int      @default(0)
  totalVolume     Float    @default(0)
  prsAchieved     Int      @default(0)
  
  joinedAt        DateTime @default(now())
  leftAt          DateTime?
  
  @@unique([partyId, userId])
  @@index([partyId])
  @@map("party_participants")
}

model PartyEvent {
  id              String   @id @default(uuid())
  partyId         String
  party           WorkoutParty @relation(fields: [partyId], references: [id], onDelete: Cascade)
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  eventType       String   // set_completed, pr_achieved, exercise_started, reaction, joined, left
  eventData       Json?    // { exerciseName, weight, reps, reactionType, etc }
  
  createdAt       DateTime @default(now())
  
  @@index([partyId, createdAt(sort: Desc)])
  @@map("party_events")
}

// ==================== EXERCISE LEADERBOARDS ====================

model ExerciseLeaderboard {
  id              String   @id @default(uuid())
  exerciseId      String
  exercise        Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  estimated1RM    Float    // Brzycki formula: weight * (36 / (37 - reps))
  bestWeight      Float
  bestReps        Int
  weightClass     String?  // lightweight (<70kg), middleweight (70-85kg), heavyweight (>85kg)
  
  globalRank      Int?
  classRank       Int?
  
  achievedAt      DateTime
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([exerciseId, userId])
  @@index([exerciseId, estimated1RM(sort: Desc)])
  @@index([exerciseId, weightClass, estimated1RM(sort: Desc)])
  @@map("exercise_leaderboards")
}

// ==================== PR PREDICTIONS ====================

model PRPrediction {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  exerciseId      String
  exercise        Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  
  currentMax      Float
  predictedMax    Float
  suggestedWeight Float
  confidence      Float    // 0-1
  trend           String   // improving, plateau, declining
  
  readyForPR      Boolean  @default(false)
  notificationSent Boolean @default(false)
  
  expiresAt       DateTime
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([userId, exerciseId])
  @@index([userId, readyForPR])
  @@map("pr_predictions")
}
